<?php

/**
 * @file
 * AVC Email Reply module.
 *
 * Allows group members to reply to notification emails to create comments.
 */

use Drupal\Core\Mail\MailFormatHelper;

/**
 * Implements hook_mail().
 */
function avc_email_reply_mail($key, &$message, $params) {
  switch ($key) {
    case 'group_comment':
      $message['subject'] = $params['subject'];
      $message['body'][] = $params['body'];

      // Add reply-to address with token if available.
      if (!empty($params['reply_token'])) {
        $config = \Drupal::config('avc_email_reply.settings');
        $reply_address = $params['reply_token'] . '@' . \Drupal::request()->getHost();
        $message['headers']['Reply-To'] = $reply_address;

        // Add X-Entity-ID header for tracking.
        if (!empty($params['entity_id'])) {
          $message['headers']['X-Entity-ID'] = $params['entity_id'];
        }

        // Add X-Entity-Type header for tracking.
        if (!empty($params['entity_type'])) {
          $message['headers']['X-Entity-Type'] = $params['entity_type'];
        }
      }
      break;
  }
}

/**
 * Implements hook_mail_alter().
 */
function avc_email_reply_mail_alter(&$message) {
  // Add reply tracking to supported notification emails.
  $config = \Drupal::config('avc_email_reply.settings');

  if (!$config->get('enabled')) {
    return;
  }

  $supported_keys = [
    'avc_notification_group_comment',
    'avc_notification_group_content_update',
    'avc_notification_workflow_advance',
  ];

  if (in_array($message['id'], $supported_keys) && !empty($message['params']['entity'])) {
    $entity = $message['params']['entity'];
    $recipient_email = $message['to'];

    // Load user by email to get the user ID.
    $users = \Drupal::entityTypeManager()
      ->getStorage('user')
      ->loadByProperties(['mail' => $recipient_email]);
    $user = reset($users);

    if (!$user) {
      return;
    }

    // Get group ID if available.
    $group_id = NULL;
    if (!empty($message['params']['group'])) {
      $group_id = $message['params']['group']->id();
    }

    /** @var \Drupal\avc_email_reply\Service\ReplyTokenService $token_service */
    $token_service = \Drupal::service('avc_email_reply.reply_token');

    // Generate reply token.
    $token = $token_service->generateToken(
      $entity->getEntityTypeId(),
      (int) $entity->id(),
      (int) $user->id(),
      $group_id
    );

    // Add Reply-To header with token.
    $reply_domain = $config->get('reply_domain') ?: \Drupal::request()->getHost();
    $reply_address = 'reply+' . $token . '@' . $reply_domain;
    $message['headers']['Reply-To'] = $reply_address;

    // Add unique Message-ID for threading.
    $message['headers']['Message-ID'] = '<' . $token . '@' . $reply_domain . '>';

    // Add instructions to email body.
    $reply_instructions = "\n\n---\n" . t('Reply to this email to add a comment. Your reply will be shared with all group members.') . "\n";
    $message['body'][] = $reply_instructions;
  }
}

/**
 * Implements hook_theme().
 */
function avc_email_reply_theme($existing, $type, $theme, $path) {
  return [
    'email_reply_comment' => [
      'variables' => [
        'comment' => NULL,
        'author' => NULL,
        'created' => NULL,
        'entity' => NULL,
      ],
    ],
  ];
}

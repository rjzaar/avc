<?php

/**
 * @file
 * Guild system for AV Commons.
 */

use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\group\Entity\GroupInterface;

/**
 * Implements hook_help().
 */
function avc_guild_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'help.page.avc_guild':
      $output = '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('Provides Guild group type with mentorship, scoring, and endorsements for AV Commons.') . '</p>';
      $output .= '<h4>' . t('Guild Roles') . '</h4>';
      $output .= '<ul>';
      $output .= '<li>' . t('<strong>Junior</strong> - New members who need ratification for their work') . '</li>';
      $output .= '<li>' . t('<strong>Endorsed</strong> - Members who can work independently') . '</li>';
      $output .= '<li>' . t('<strong>Mentor</strong> - Can ratify junior work and train members') . '</li>';
      $output .= '<li>' . t('<strong>Admin</strong> - Full guild administration') . '</li>';
      $output .= '</ul>';
      return $output;
  }
}

/**
 * Implements hook_theme().
 */
function avc_guild_theme($existing, $type, $theme, $path) {
  return [
    'guild_dashboard' => [
      'variables' => [
        'guild' => NULL,
        'members' => [],
        'leaderboard' => [],
        'ratification_queue' => [],
        'recent_activity' => [],
      ],
    ],
    'guild_member_profile' => [
      'variables' => [
        'user' => NULL,
        'guild' => NULL,
        'role' => NULL,
        'score' => 0,
        'skills' => [],
        'endorsements' => [],
      ],
    ],
    'ratification_queue' => [
      'variables' => [
        'items' => [],
        'empty_message' => NULL,
      ],
    ],
    'skill_endorsements' => [
      'variables' => [
        'skill' => NULL,
        'endorsements' => [],
        'can_endorse' => FALSE,
      ],
    ],
    'guild_leaderboard' => [
      'variables' => [
        'guild' => NULL,
        'entries' => [],
        'limit' => 10,
      ],
    ],
  ];
}

/**
 * Check if a group is a guild.
 *
 * @param \Drupal\group\Entity\GroupInterface $group
 *   The group to check.
 *
 * @return bool
 *   TRUE if the group is a guild.
 */
function avc_guild_is_guild(GroupInterface $group) {
  return $group->bundle() === 'guild';
}

/**
 * Get the guild role for a user in a guild.
 *
 * @param \Drupal\group\Entity\GroupInterface $guild
 *   The guild.
 * @param \Drupal\Core\Session\AccountInterface $user
 *   The user.
 *
 * @return string|null
 *   The role ID (junior, endorsed, mentor, admin) or NULL if not a member.
 */
function avc_guild_get_member_role(GroupInterface $guild, $user) {
  if (!avc_guild_is_guild($guild)) {
    return NULL;
  }

  $membership = $guild->getMember($user);
  if (!$membership) {
    return NULL;
  }

  // Check roles in order of highest to lowest.
  $roles = $membership->getRoles();
  foreach (['guild-admin', 'guild-mentor', 'guild-endorsed', 'guild-junior'] as $role_id) {
    if (isset($roles[$role_id])) {
      return str_replace('guild-', '', $role_id);
    }
  }

  // Default to junior for members without explicit role.
  return 'junior';
}

/**
 * Check if a user can ratify work in a guild.
 *
 * @param \Drupal\group\Entity\GroupInterface $guild
 *   The guild.
 * @param \Drupal\Core\Session\AccountInterface $user
 *   The user.
 *
 * @return bool
 *   TRUE if the user can ratify.
 */
function avc_guild_can_ratify(GroupInterface $guild, $user) {
  $role = avc_guild_get_member_role($guild, $user);
  return in_array($role, ['mentor', 'admin']);
}

/**
 * Check if a user can endorse skills in a guild.
 *
 * @param \Drupal\group\Entity\GroupInterface $guild
 *   The guild.
 * @param \Drupal\Core\Session\AccountInterface $user
 *   The user.
 *
 * @return bool
 *   TRUE if the user can endorse.
 */
function avc_guild_can_endorse(GroupInterface $guild, $user) {
  $role = avc_guild_get_member_role($guild, $user);
  return in_array($role, ['endorsed', 'mentor', 'admin']);
}

/**
 * Check if a user needs ratification for their work.
 *
 * @param \Drupal\group\Entity\GroupInterface $guild
 *   The guild.
 * @param \Drupal\Core\Session\AccountInterface $user
 *   The user.
 *
 * @return bool
 *   TRUE if the user needs ratification.
 */
function avc_guild_needs_ratification(GroupInterface $guild, $user) {
  // Check if guild requires ratification.
  if ($guild->hasField('field_ratification_required')) {
    if (!$guild->get('field_ratification_required')->value) {
      return FALSE;
    }
  }

  $role = avc_guild_get_member_role($guild, $user);
  return $role === 'junior';
}

/**
 * Implements hook_ENTITY_TYPE_insert() for skill_endorsement.
 */
function avc_guild_skill_endorsement_insert($entity) {
  // Queue notification for the endorsed user.
  if (\Drupal::moduleHandler()->moduleExists('avc_notification')) {
    $notification_service = \Drupal::service('avc_notification.service');

    $endorsed_user = $entity->getEndorsedUser();
    $endorser = $entity->getEndorser();
    $skill = $entity->getSkill();
    $guild = $entity->getGuild();

    if ($endorsed_user && $endorser && $skill && $guild) {
      $notification_service->queueEndorsement(
        $endorsed_user,
        $endorser,
        $skill->label(),
        $guild
      );
    }
  }
}

/**
 * Implements hook_ENTITY_TYPE_update() for ratification.
 */
function avc_guild_ratification_update($entity) {
  // Queue notification when ratification is completed.
  if ($entity->original && $entity->getStatus() != $entity->original->getStatus()) {
    if (in_array($entity->getStatus(), ['approved', 'rejected'])) {
      if (\Drupal::moduleHandler()->moduleExists('avc_notification')) {
        $notification_service = \Drupal::service('avc_notification.service');

        $junior = $entity->getJunior();
        $mentor = $entity->getMentor();
        $asset = $entity->getAsset();
        $guild = $entity->getGuild();

        if ($junior && $mentor && $asset && $guild) {
          $notification_service->queueRatificationComplete(
            $junior,
            $mentor,
            $asset,
            $entity->getStatus() === 'approved',
            $entity->getFeedback() ?? '',
            $guild
          );
        }
      }
    }
  }
}

/**
 * Implements hook_group_content_insert().
 */
function avc_guild_group_content_insert($group_content) {
  // Queue notification when a user's guild role changes to indicate promotion.
  $group = $group_content->getGroup();
  if (!avc_guild_is_guild($group)) {
    return;
  }

  // Check if this is a role change that represents a promotion.
  // This is simplified - in a real system you'd track the previous role.
  $entity = $group_content->getEntity();
  if ($entity && $entity->getEntityTypeId() === 'user') {
    $roles = $group_content->get('group_roles')->getValue();
    foreach ($roles as $role_item) {
      $role_id = $role_item['target_id'];
      if (in_array($role_id, ['guild-endorsed', 'guild-mentor', 'guild-admin'])) {
        if (\Drupal::moduleHandler()->moduleExists('avc_notification')) {
          $notification_service = \Drupal::service('avc_notification.service');
          $role_name = str_replace('guild-', '', $role_id);
          $notification_service->queueGuildPromotion(
            $entity,
            $role_name,
            $group
          );
        }
      }
    }
  }
}
